dist: trusty
sudo: required
language: python
# The travis Python version is unrelated to the version we build and test
# with.  This is set with the MB_PYTHON_VERSION variable.
python: 3.5
services: docker

branches:
  only:
    - master
    # We want to build wip/* branches since these are not usually used for PRs
    - /^wip\/.*$/
    # We want to build version tags as well.
    - /^v\d+\.\d+.*$/

env:
  global:
    # directory containing the project source
    - REPO_DIR=.
    # pip dependencies to _build_ project
    # - BUILD_DEPENDS="..."
    # pip dependencies to _test_ project
    - TEST_DEPENDS="-rdev-requirements.txt"
    - PLAT=x86_64
    - UNICODE_WIDTH=32

matrix:
  exclude:
    # Exclude the default Python 3.5 build
    - python: 3.5
  include:
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=2.7
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.6

cache: pip

before_install:
  - source multibuild/common_utils.sh
  - source multibuild/travis_steps.sh
  - before_install

install:
  - build_wheel $REPO_DIR $PLAT

script:
  - install_run $PLAT

after_success:
  - pip install tox
  # upload code coverage to Codecov.io
  - tox -e codecov
  # if tagged, create the source distribution for the deploy stage
  - if [ -n "$TRAVIS_TAG" ] && [ "$BUILD_SDIST" == true ]; then tox -e sdist; fi
  # copy compiled wheels to dist/ where Travis `dpl` tool can find them and upload to PyPI
  - if [ -n "$TRAVIS_TAG" ]; then mkdir -p dist; cp wheelhouse/*.whl dist; fi

deploy:
  provider: pypi
  on:
    tags: true
    repo: adobe-type-tools/psautohint
    all_branches: true
  user: anthrotype
  password:
    secure: NMFwzW1lWIqAxnfkSJ147zPncATi2ToDBpsu1osdxkZafndSUYJGJ1Es1oBnBkmtc73f2G1n9ZoLd3vsL/YhU5VmNJAy3mADgRtpUGAwth5CeHXSyjVNh5nSfjkr2fO3VLMnmHKbhWRHa5OjHTwr341bAIh3Ij10mCiw2Fk26IZIZ9qnp2HP43gsmCNVag0Bp7MhEXiH+mJ2d2R5T/4RNeh1TpQq2NRn5/dIHPX5Y1YAxRF1C0wqu6o3Vyl8NwmS16nH0u7KtGg/hYzFO1s+DdeewRBMzy6v3AZ8faBgsolXMN96i2gVZeAoosCihWflRkkmNioYnPPHWItZFNc7yVv1GMrw1C2dezM9LnpAPKjHFbPm4TahM4sCitgmFIwxFf4Oh8+49rZj75WxnmYCJ/lQWyd84LQG32vj7hnFi/fDV1GVZ+PfrAL6Q/kk1natKSBn9Ue6l3a1uXnzk0/aQR/JuBz+7+Q0uX/4JGcB6QpZRL7KsojinHlb1j8ijuUrbFTepos8IC4Tc5z3GdJxaxbX3F+wNLIfB1p1KMbjb3/vjJSUX6BZ10SOYqCtsxJaQjcfBbZgGtf1KlhJAuDDpwwlFseqi87hyrhK2hFaqq0ha7yD/jXcDrTF0DRDooFNVSiDadtCU8lrfr05Ue5emw/fbjgRzMtPRiNBTQs5IAw=
  # 'check' is a do-nothing setup.py command, to prevent Travis from trying
  # to rebuild the wheel we just built with multibuild
  distributions: check
  skip_cleanup: true
  skip_upload_docs: true
